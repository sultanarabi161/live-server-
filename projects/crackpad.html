<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dropbox Notepad</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.0.3/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.3/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/markdown/markdown.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.css">
    <style>
        .CodeMirror {
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold mb-6">Enhanced Dropbox Notepad</h1>
        
        <div id="noteSection">
            <div class="flex mb-4">
                <input type="text" id="fileName" placeholder="File name" class="flex-grow p-2 border rounded-l">
                <select id="fileFormat" class="p-2 border-t border-b border-r">
                    <option value="txt">.txt</option>
                    <option value="md">.md</option>
                </select>
            </div>
            
            <div class="mb-4">
                <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
            </div>
            
            <div class="flex space-x-2 mb-4">
                <button onclick="saveNote()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Save Note</button>
                <button onclick="window.open('https://www.dropbox.com/scl/fo/4zfbacff21gh4j3sxt6lf/ADQX-aKb_hSW07tL7u7hAxE?rlkey=s1nt2pqvy2gpqmfihqxkc3obn&st=rgbjdd5c&dl=0', '_blank'); loadNotes();" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Load Notes</button>
                <button onclick="togglePreview()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">Toggle Preview</button>
                <button onclick="createFolder()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">Create Folder</button>
            </div>

            <div id="previewArea" class="hidden mb-4 p-4 border rounded"></div>
            
            <div id="folderStructure" class="mb-4"></div>
            
            <div id="fileList" class="border rounded p-4"></div>

            <div id="searchSection" class="mt-4">
                <input type="text" id="searchInput" placeholder="Search notes..." class="w-full p-2 border rounded mb-2">
                <button onclick="searchNotes()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Search</button>
            </div>
        </div>
    </div>

    <script>
        const ACCESS_TOKEN = 'sl.B-vZHd7dsfYVPcsYHZzJaNVhkR5eUoIYH2v7VyoQg5ZjGxryDlAIvKLnaKXuiAUKEie7ajxlOmdsAujthmvJAw5LP-g7CQ1N2Qj9pgMrwboj6fmD9_Q0IcObLzdp-SHfwPkRQwITP5bMP2Ix8Sm1Nyk';
        const dbx = new Dropbox.Dropbox({ accessToken: ACCESS_TOKEN });
        const folderPath = '/enhanced_notes/';
        let editor;
        
        document.addEventListener('DOMContentLoaded', () => {
            editor = CodeMirror.fromTextArea(document.getElementById('noteArea'), {
                mode: 'markdown',
                lineNumbers: true,
                theme: 'default'
            });
            loadNotes();
            loadFolderStructure();
        });

        function saveNote() {
            const fileName = document.getElementById('fileName').value.trim() || `note_${new Date().toISOString().replace(/[:.]/g, '-')}`;
            const fileFormat = document.getElementById('fileFormat').value;
            const noteContent = editor.getValue();
            const filePath = `${folderPath}${fileName}.${fileFormat}`;

            dbx.filesUpload({ path: filePath, contents: noteContent, mode: 'overwrite' })
                .then(response => {
                    console.log("Note saved to Dropbox:", response);
                    alert("Note saved successfully!");
                    loadNotes();
                })
                .catch(error => {
                    console.error("Error saving note:", error);
                    alert("Failed to save note. Please check the console for more details.");
                });
        }

        function loadNotes() {
            dbx.filesListFolder({ path: folderPath })
                .then(response => {
                    const files = response.entries;
                    const fileListDiv = document.getElementById('fileList');
                    fileListDiv.innerHTML = '<h3 class="font-bold mb-2">Files:</h3>';

                    files.forEach(file => {
                        if (file['.tag'] === 'file') {
                            const fileDiv = document.createElement('div');
                            fileDiv.className = 'flex justify-between items-center mb-2';

                            // Create a temporary link for each file
                            dbx.filesGetTemporaryLink({ path: file.path_lower })
                                .then(linkResponse => {
                                    const fileLink = document.createElement('a');
                                    fileLink.href = linkResponse.link;
                                    fileLink.target = '_blank'; // Opens in a new tab
                                    fileLink.textContent = file.name;
                                    fileLink.className = 'text-blue-500 hover:underline';

                                    const deleteButton = document.createElement('button');
                                    deleteButton.textContent = 'Delete';
                                    deleteButton.className = 'bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600';
                                    deleteButton.onclick = () => deleteNote(file.path_lower);

                                    fileDiv.appendChild(fileLink);
                                    fileDiv.appendChild(deleteButton);
                                    fileListDiv.appendChild(fileDiv);
                                })
                                .catch(error => {
                                    console.error("Error getting temporary link:", error);
                                    alert("Failed to generate a link. Please check the console for more details.");
                                });
                        }
                    });
                })
                .catch(error => {
                    console.error("Error loading file list:", error);
                    alert("Failed to load file list. Please check the console for more details.");
                });
        }

        function loadNote(filePath) {
            dbx.filesDownload({ path: filePath })
                .then(response => {
                    const reader = new FileReader();
                    reader.onload = function() {
                        editor.setValue(reader.result);
                        document.getElementById('fileName').value = filePath.split('/').pop().split('.')[0];
                        document.getElementById('fileFormat').value = filePath.split('.').pop();
                        console.log("Note loaded from Dropbox:", reader.result);
                        alert("Note loaded successfully!");
                    };
                    reader.readAsText(response.fileBlob);
                })
                .catch(error => {
                    console.error("Error loading note:", error);
                    alert("Failed to load note. Please check the console for more details.");
                });
        }

        function deleteNote(filePath) {
            if (confirm('Are you sure you want to delete this note?')) {
                dbx.filesDelete({ path: filePath })
                    .then(response => {
                        console.log("Note deleted from Dropbox:", response);
                        alert("Note deleted successfully!");
                        loadNotes();
                    })
                    .catch(error => {
                        console.error("Error deleting note:", error);
                        alert("Failed to delete note. Please check the console for more details.");
                    });
            }
        }

        function togglePreview() {
            const previewArea = document.getElementById('previewArea');
            
            if (previewArea.classList.contains('hidden')) {
                const noteContent = editor.getValue();
                const fileFormat = document.getElementById('fileFormat').value;
                
                let htmlContent;
                if (fileFormat === 'md') {
                    htmlContent = DOMPurify.sanitize(marked(noteContent));
                } else {
                    htmlContent = DOMPurify.sanitize(noteContent.replace(/\n/g, '<br>'));
                }
                
                previewArea.innerHTML = htmlContent;
                previewArea.classList.remove('hidden');
                editor.getWrapperElement().style.display = 'none';
            } else {
                previewArea.classList.add('hidden');
                editor.getWrapperElement().style.display = '';
            }
        }

        function createFolder() {
            const folderName = prompt("Enter the name for the new folder:");
            if (folderName) {
                const newFolderPath = `${folderPath}${folderName}`;
                dbx.filesCreateFolderV2({ path: newFolderPath })
                    .then(response => {
                        console.log("Folder created:", response);
                        alert("Folder created successfully!");
                        loadFolderStructure();
                    })
                    .catch(error => {
                        console.error("Error creating folder:", error);
                        alert("Failed to create folder. Please check the console for more details.");
                    });
            }
        }

        function loadFolderStructure() {
            console.log("Loading folder structure from:", folderPath);
            dbx.filesListFolder({ path: folderPath, recursive: true })
                .then(response => {
                    console.log("Folder structure response:", response);
                    const folderStructure = {};
                    response.entries.forEach(entry => {
                        const path = entry.path_display.split('/');
                        let current = folderStructure;
                        path.forEach((part, index) => {
                            if (index > 1) { // Skip the first two parts (/enhanced_notes)
                                if (!current[part]) {
                                    current[part] = entry['.tag'] === 'folder' ? {} : null;
                                }
                                current = current[part];
                            }
                        });
                    });
                    renderFolderStructure(folderStructure);
                })
                .catch(error => {
                    console.error("Error loading folder structure:", error);
                    alert("Failed to load folder structure. Please check the console for more details.");
                });
        }

        function renderFolderStructure(structure, path = '') {
            const folderStructureDiv = document.getElementById('folderStructure');
            folderStructureDiv.innerHTML = '<h3 class="font-bold mb-2">Folder Structure:</h3>';
            
            function renderLevel(obj, level = 0) {
                const ul = document.createElement('ul');
                ul.className = 'ml-4';
                for (const [key, value] of Object.entries(obj)) {
                    const li = document.createElement('li');
                    li.className = 'mb-1';
                    if (value === null) {
                        li.innerHTML = `<span class="text-blue-500 cursor-pointer" onclick="loadNote('${folderPath}${path}${key}')">${key}</span>`;
                    } else {
                        li.innerHTML = `<span class="font-semibold">${key}/</span>`;
                        li.appendChild(renderLevel(value, level + 1));
                    }
                    ul.appendChild(li);
                }
                return ul;
            }
            
            folderStructureDiv.appendChild(renderLevel(structure));
        }

        function searchNotes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            dbx.filesSearch({ path: folderPath, query: searchTerm })
                .then(response => {
                    const searchResults = response.matches.map(match => match.metadata);
                    const fileListDiv = document.getElementById('fileList');
                    fileListDiv.innerHTML = '<h3 class="font-bold mb-2">Search Results:</h3>';

                    searchResults.forEach(file => {
                        if (file['.tag'] === 'file') {
                            const fileDiv = document.createElement('div');
                            fileDiv.className = 'flex justify-between items-center mb-2';
                            
                            const fileLink = document.createElement('a');
                            fileLink.href = '#';
                            fileLink.textContent = file.name;
                            fileLink.className = 'text-blue-500 hover:underline';
                            fileLink.onclick = () => loadNote(file.path_lower);
                            
                            fileDiv.appendChild(fileLink);
                            fileListDiv.appendChild(fileDiv);
                        }
                    });
                })
                .catch(error => {
                    console.error("Error searching notes:", error);
                    alert("Failed to search notes. Please check the console for more details.");
                });
        }
    </script>
</body>
</html>
